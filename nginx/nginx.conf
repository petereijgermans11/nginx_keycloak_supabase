worker_processes auto;
error_log /dev/stderr info;

events {
    worker_connections 1024;
}

http {
    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/site/lualib/?.lua;/usr/local/openresty/nginx/?.lua;;";

    lua_shared_dict discovery 1m;
    lua_shared_dict jwks 1m;
    lua_shared_dict sessions 10m;

    # DNS resolver voor Docker
    resolver 127.0.0.11 ipv6=off;
    resolver_timeout 5s;

    access_log /dev/stdout;

    upstream api_upstream {
        server api:3000;
    }

    server {
        listen 8080;
        server_name localhost;

        # Health check
        location /health {
            access_log off;
            return 200 "OK\n";
        }

        # Proxy Keycloak endpoints (voor browser redirects via externe poort)
        location /realms/ {
            proxy_pass http://keycloak:8080;
            proxy_set_header Host $host:$server_port;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # Protected API
        location /api/ {
            access_by_lua_block {
                local oidc_helper = require "oidc_helper"
                
                -- Check if user has valid session
                local session = oidc_helper.get_session()
                if session and session.access_token then
                    -- User is authenticated, pass request through
                    ngx.req.set_header("X-User-Id", session.sub or "")
                    ngx.req.set_header("Authorization", "Bearer " .. session.access_token)
                    return
                end
                
                -- No valid session, redirect to Keycloak
                local opts = {
                    authorization_endpoint = "http://localhost:8180/realms/nginx_keycloak_api/protocol/openid-connect/auth",
                    token_endpoint = "http://keycloak:8080/realms/nginx_keycloak_api/protocol/openid-connect/token",
                    client_id = "nginx-client",
                    client_secret = "ECHTE_SECRET",
                    redirect_uri = "http://localhost:8080/callback",
                    scope = "openid profile email"
                }
                
                local auth_url = oidc_helper.build_authorization_url(opts)
                
                -- Store state and nonce in a temporary cookie for callback verification
                local state_data = {
                    state = ngx.ctx.oidc_state,
                    nonce = ngx.ctx.oidc_nonce,
                    timestamp = ngx.time()
                }
                local state_json = require("cjson").encode(state_data)
                local state_cookie = ngx.encode_base64(state_json)
                ngx.header["Set-Cookie"] = "oidc_state=" .. state_cookie .. "; Path=/; HttpOnly; SameSite=Lax; Max-Age=300"
                
                return ngx.redirect(auth_url)
            }

            proxy_pass http://api_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # OIDC callback
        location /callback {
            content_by_lua_block {
                local oidc_helper = require "oidc_helper"
                local cjson = require "cjson"
                
                local args = ngx.req.get_uri_args()
                local code = args.code
                local state = args.state
                
                if not code then
                    ngx.status = 400
                    ngx.say("Missing authorization code")
                    return ngx.exit(400)
                end
                
                -- Verify state
                local state_cookie = ngx.var.cookie_oidc_state
                if state_cookie then
                    local state_json = ngx.decode_base64(state_cookie)
                    if state_json then
                        local ok, state_data = pcall(cjson.decode, state_json)
                        if ok and state_data.state ~= state then
                            ngx.status = 400
                            ngx.say("Invalid state parameter")
                            return ngx.exit(400)
                        end
                    end
                end
                
                -- Exchange code for tokens
                local opts = {
                    token_endpoint = "http://keycloak:8080/realms/nginx_keycloak_api/protocol/openid-connect/token",
                    client_id = "nginx-client",
                    client_secret = "ECHTE_SECRET",
                    redirect_uri = "http://localhost:8080/callback"
                }
                
                local tokens, err = oidc_helper.exchange_code_for_tokens(opts, code)
                if err then
                    ngx.log(ngx.ERR, "Token exchange error: ", err)
                    ngx.status = 500
                    ngx.say("Authentication failed: " .. err)
                    return ngx.exit(500)
                end
                
                -- Decode ID token to get user info (simple base64 decode, no verification for now)
                local id_token_parts = {}
                for part in string.gmatch(tokens.id_token, "[^%.]+") do
                    table.insert(id_token_parts, part)
                end
                
                local payload_json = ngx.decode_base64(id_token_parts[2])
                local ok, payload = pcall(cjson.decode, payload_json)
                
                local session_data = {
                    access_token = tokens.access_token,
                    id_token = tokens.id_token,
                    refresh_token = tokens.refresh_token,
                    sub = ok and payload.sub or nil,
                    email = ok and payload.email or nil,
                    name = ok and payload.name or nil
                }
                
                -- Set session cookie
                local session_cookie = oidc_helper.set_session(session_data, 3600)
                
                -- Clear old state cookie by setting Max-Age=0
                local clear_state_cookie = "oidc_state=; Path=/; HttpOnly; SameSite=Lax; Max-Age=0"
                
                -- IMPORTANT: Set both cookies explicitly
                -- OpenResty requires table format for multiple Set-Cookie headers
                local cookies = {}
                table.insert(cookies, session_cookie)
                table.insert(cookies, clear_state_cookie)
                ngx.header["Set-Cookie"] = cookies
                
                -- Use HTML redirect with delay to ensure browser saves cookies first
                ngx.header["Content-Type"] = "text/html; charset=utf-8"
                ngx.header["Cache-Control"] = "no-cache, no-store, must-revalidate"
                ngx.say([[<!DOCTYPE html>
<html><head><title>Login succesvol</title></head>
<body>
<p>Login succesvol! Redirecting to app...</p>
<script>
// Give browser time to save cookies before redirect
setTimeout(function() {
    window.location.href = '/api/data';
}, 500);
</script>
</body></html>]])
                return ngx.exit(ngx.HTTP_OK)
            }
        }

        # Logout endpoint
        location /logout {
            content_by_lua_block {
                local oidc_helper = require "oidc_helper"
                local clear_cookie = oidc_helper.clear_session()
                ngx.header["Set-Cookie"] = clear_cookie
                
                local args = ngx.req.get_uri_args()
                local redirect_uri = args.redirect_uri or "http://localhost:8081"
                
                -- Optionally redirect to Keycloak logout
                local keycloak_logout = "http://localhost:8180/realms/nginx_keycloak_api/protocol/openid-connect/logout?redirect_uri=" .. ngx.escape_uri(redirect_uri)
                return ngx.redirect(keycloak_logout)
            }
        }

        # Redirect root to webapp
        location = / {
            return 302 http://localhost:8081/;
        }
    }
}
